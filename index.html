<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Szuper Mario - Animáció & Szupererő</title>
    <style>
        body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #222; font-family: 'Arial Black', sans-serif; overflow: hidden; }
        #game-container { position: relative; width: 800px; height: 450px; border: 6px solid #444; background: #5c94fc; }
        canvas { display: block; }
        #hud { position: absolute; top: 10px; left: 10px; color: white; text-shadow: 2px 2px #000; font-size: 20px; pointer-events: none; width: 95%; display: flex; justify-content: space-between; }
        .menu { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 20; text-align: center; }
        button { padding: 15px 30px; font-size: 20px; cursor: pointer; background: #e52521; color: white; border: 4px solid #fff; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="hud">
            <div>SZINT: <span id="lvl">1</span> | PONT: <span id="score">0</span></div>
            <div id="power-txt" style="color: yellow;"></div>
            <div>ÉLET: <span id="hp">3</span></div>
        </div>

        <div id="start-menu" class="menu">
            <h1 style="font-size: 50px; color: #ff4500;">SZUPER MARIO</h1>
            <p>Irányítás: Nyilak = Mozgás | Space = Ugrás | F = Tűzgolyó</p>
            <button onclick="startGame()">KALAND INDÍTÁSA</button>
        </div>

        <canvas id="canvas" width="800" height="450"></canvas>
    </div>

    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");

        // --- JÁTÉK ÁLLAPOT ---
        let gameRunning = false;
        let currentLevel = 1;
        let score = 0;
        let hp = 3;
        let camX = 0;
        let animFrame = 0;

        const player = {
            x: 100, y: 300, w: 35, h: 50,
            vx: 0, vy: 0, speed: 5,
            jumping: false, facing: 1,
            hasPower: false, fireballs: []
        };

        let blocks = [];
        let enemies = [];
        let items = [];

        // --- HANGOK ---
        const audio = new (window.AudioContext || window.webkitAudioContext)();
        function playNote(f, t, d) {
            const o = audio.createOscillator();
            const g = audio.createGain();
            o.frequency.value = f; o.type = t;
            o.connect(g); g.connect(audio.destination);
            g.gain.setValueAtTime(0.1, audio.currentTime);
            o.start(); o.stop(audio.currentTime + d);
        }

        // --- PÁLYA ÉPÍTÉS ---
        function buildLevel(lvl) {
            blocks = []; enemies = []; items = []; camX = 0;
            player.x = 100; player.y = 300;
            
            if (lvl === 1) {
                // Talaj
                addBlock(0, 400, 2000, 50, 'grass');
                // Lucky blokkok
                addBlock(300, 250, 40, 40, 'lucky');
                addBlock(500, 200, 40, 40, 'brick');
                addBlock(540, 200, 40, 40, 'lucky');
                addBlock(580, 200, 40, 40, 'brick');
                // Ellenségek
                enemies.push({x: 600, y: 360, w: 40, h: 40, vx: -2, type: 'goomba'});
                addBlock(1800, 0, 50, 450, 'goal');
            } else {
                // Barlang szint
                addBlock(0, 400, 2000, 50, 'stone');
                addBlock(200, 300, 200, 40, 'stone');
                addBlock(500, 200, 200, 40, 'lucky');
                enemies.push({x: 700, y: 360, w: 60, h: 60, vx: -3, type: 'boss', hp: 3});
            }
        }

        function addBlock(x, y, w, h, type) {
            blocks.push({x, y, w, h, type, hit: false});
        }

        // --- KIRAJZOLÁS ---
        function drawPlayer() {
            ctx.save();
            ctx.translate(player.x, player.y);
            if (player.facing === -1) {
                ctx.scale(-1, 1);
                ctx.translate(-player.w, 0);
            }

            const color = player.hasPower ? "#fff" : "#e52521"; // Tűz Mario fehér-piros
            const pants = player.hasPower ? "#e52521" : "#0055ff";

            // Test
            ctx.fillStyle = pants;
            ctx.fillRect(5, 20, 25, 20); // Nadrág
            ctx.fillStyle = color;
            ctx.fillRect(5, 10, 25, 15); // Ing
            
            // Animált lábak
            ctx.fillStyle = "#552200";
            let legOffset = Math.sin(animFrame * 0.5) * 5;
            if (!player.jumping && player.vx !== 0) {
                ctx.fillRect(5, 40, 10, 10 + legOffset);
                ctx.fillRect(20, 40, 10, 10 - legOffset);
            } else {
                ctx.fillRect(5, 40, 10, 10);
                ctx.fillRect(20, 40, 10, 10);
            }

            // Fej & Sapka
            ctx.fillStyle = "#ffccaa"; // Bőr
            ctx.fillRect(7, 0, 20, 15);
            ctx.fillStyle = color;
            ctx.fillRect(5, -5, 25, 8); // Sapka
            
            ctx.restore();
        }

        function drawBlock(b) {
            if (b.type === 'grass') ctx.fillStyle = "#228b22";
            else if (b.type === 'brick') ctx.fillStyle = "#a52a2a";
            else if (b.type === 'lucky') ctx.fillStyle = b.hit ? "#888" : "#ffd700";
            else if (b.type === 'stone') ctx.fillStyle = "#555";
            else ctx.fillStyle = "#ffcc00";

            ctx.fillRect(b.x, b.y, b.w, b.h);
            ctx.strokeStyle = "rgba(0,0,0,0.2)";
            ctx.strokeRect(b.x, b.y, b.w, b.h);

            if (b.type === 'lucky' && !b.hit) {
                ctx.fillStyle = "white";
                ctx.font = "20px Arial";
                ctx.fillText("?", b.x + 15, b.y + 28);
            }
        }

        // --- JÁTÉK CIKLUS ---
        const keys = {};
        window.onkeydown = e => keys[e.code] = true;
        window.onkeyup = e => keys[e.code] = false;

        function startGame() {
            document.getElementById("start-menu").style.display = "none";
            buildLevel(1);
            gameRunning = true;
            if (audio.state === 'suspended') audio.resume();
            loop();
        }

        function update() {
            // Mozgás & Animáció
            if (keys["ArrowRight"]) { player.vx = player.speed; player.facing = 1; animFrame++; }
            else if (keys["ArrowLeft"]) { player.vx = -player.speed; player.facing = -1; animFrame++; }
            else { player.vx = 0; }

            if (keys["Space"] && !player.jumping) {
                player.vy = -15; player.jumping = true;
                playNote(400, 'square', 0.1);
            }

            // Tűzgolyó lövés
            if (keys["KeyF"] && player.hasPower && player.fireballs.length < 3) {
                player.fireballs.push({x: player.x + 20, y: player.y + 20, vx: player.facing * 8, vy: 2});
                player.hasPower = true; // marad a power
                playNote(600, 'sine', 0.1);
                keys["KeyF"] = false; // ne lőjön sorozatban
            }

            player.vy += 0.8;
            player.x += player.vx;
            player.y += player.vy;

            // Kamera
            camX = player.x - 200;
            if (camX < 0) camX = 0;

            // Ütközés blokkokkal
            player.jumping = true;
            blocks.forEach(b => {
                if (rectIntersect(player, b)) {
                    // Alulról fejelés
                    if (player.vy < 0 && player.y > b.y) {
                        player.y = b.y + b.h; player.vy = 0;
                        if (b.type === 'lucky' && !b.hit) {
                            b.hit = true;
                            items.push({x: b.x, y: b.y - 40, w: 30, h: 30, type: 'flower'});
                            playNote(500, 'sawtooth', 0.2);
                        }
                    } 
                    // Talajra érkezés
                    else if (player.vy > 0 && player.y < b.y) {
                        player.jumping = false; player.y = b.y - player.h; player.vy = 0;
                        if (b.type === 'goal') { currentLevel++; buildLevel(currentLevel); document.getElementById("lvl").innerText = currentLevel; }
                    }
                }
            });

            // Tárgyak (Szupererő)
            items.forEach((it, i) => {
                if (rectIntersect(player, it)) {
                    player.hasPower = true;
                    document.getElementById("power-txt").innerText = "TŰZ MARIO AKTÍV!";
                    items.splice(i, 1);
                    playNote(800, 'sine', 0.3);
                }
            });

            // Tűzgolyók kezelése
            player.fireballs.forEach((f, i) => {
                f.x += f.vx;
                enemies.forEach((en, ei) => {
                    if (rectIntersect(f, en)) {
                        enemies.splice(ei, 1);
                        player.fireballs.splice(i, 1);
                        score += 100;
                    }
                });
                if (f.x < camX || f.x > camX + 800) player.fireballs.splice(i, 1);
            });

            // Ellenségek
            enemies.forEach((en, i) => {
                en.x += en.vx;
                if (rectIntersect(player, en)) {
                    if (player.vy > 0 && player.y < en.y) {
                        enemies.splice(i, 1); player.vy = -10; score += 50;
                    } else {
                        hp--; player.x = 100; player.hasPower = false;
                        document.getElementById("hp").innerText = hp;
                        document.getElementById("power-txt").innerText = "";
                        if (hp <= 0) location.reload();
                    }
                }
            });
        }

        function rectIntersect(a, b) {
            return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-camX, 0);

            blocks.forEach(drawBlock);
            items.forEach(it => {
                ctx.fillStyle = "orange";
                ctx.beginPath(); ctx.arc(it.x + 15, it.y + 15, 15, 0, 7); ctx.fill();
            });
            enemies.forEach(en => {
                ctx.fillStyle = en.type === 'boss' ? "purple" : "#8b4513";
                ctx.fillRect(en.x, en.y, en.w, en.h);
            });
            player.fireballs.forEach(f => {
                ctx.fillStyle = "red";
                ctx.beginPath(); ctx.arc(f.x, f.y, 8, 0, 7); ctx.fill();
            });

            drawPlayer();
            ctx.restore();
            document.getElementById("score").innerText = score;
        }

        function loop() {
            if (!gameRunning) return;
            update();
            draw();
            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
