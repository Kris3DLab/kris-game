<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Szuper Mario - A Teljes Játék</title>
    <style>
        body { margin: 0; background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Arial', sans-serif; overflow: hidden; }
        #game-container { position: relative; width: 800px; height: 450px; border: 4px solid #fff; background: #5c94fc; overflow: hidden; }
        canvas { display: block; }
        
        /* UI és Menük */
        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; z-index: 100; text-align: center;
        }
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; padding: 10px;
            display: flex; justify-content: space-around; color: white;
            font-weight: bold; font-size: 20px; text-shadow: 2px 2px #000; pointer-events: none;
        }
        button { padding: 15px 30px; font-size: 20px; cursor: pointer; background: #e52521; color: white; border: none; font-weight: bold; margin-top: 15px; }
        button:hover { background: #ff4500; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="hud">
        <div>PÁLYA: <span id="lvl">1</span></div>
        <div>ÉLET: <span id="hp">3</span></div>
        <div>PONT: <span id="score">0</span></div>
    </div>

    <div id="start-screen" class="overlay">
        <h1>SZUPER MARIO</h1>
        <p>A TELJES KALAND</p>
        <button onclick="startGame()">INDÍTÁS</button>
    </div>

    <div id="game-over" class="overlay" style="display:none">
        <h1>VESZTETTÉL</h1>
        <button onclick="location.reload()">ÚJRAPRÓBÁLÁS</button>
    </div>

    <div id="win-screen" class="overlay" style="display:none">
        <h1 style="color: gold;">GRATULÁLUNK!</h1>
        <p>Legyőzted a Boss-t és megmentetted a birodalmat!</p>
        <button onclick="location.reload()">FŐMENÜ</button>
    </div>

    <canvas id="canvas" width="800" height="450"></canvas>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// --- JÁTÉK MOTOR ADATOK ---
let gameRunning = false;
let currentLevel = 1;
let score = 0;
let lives = 3;
let cameraX = 0;
let worldWidth = 2500; // A pálya tényleges hossza

const player = {
    x: 100, y: 300, w: 35, h: 50,
    vx: 0, vy: 0, speed: 5,
    jumping: false, facing: 1,
    power: false, fireballs: []
};

let platforms = [];
let enemies = [];
let luckyBlocks = [];
let fireFlowers = [];

// --- PÁLYA TERVEZÉS ---
function setupLevel(lvl) {
    platforms = []; enemies = []; luckyBlocks = []; fireFlowers = [];
    player.x = 50; player.y = 300; cameraX = 0;
    document.getElementById("lvl").innerText = lvl;

    if (lvl === 1) {
        worldWidth = 2000;
        addRect(0, 400, 2500, 50, "ground"); // Alap
        addLucky(400, 250);
        addRect(600, 250, 120, 40, "brick");
        addLucky(800, 150);
        addEnemy(700, 360);
        addEnemy(1200, 360);
        addRect(1900, 100, 20, 300, "goal"); // Céloszlop
    } else if (lvl === 2) {
        worldWidth = 2500;
        addRect(0, 400, 1000, 50, "ground");
        addRect(1200, 400, 1500, 50, "ground"); // Szakadék középen!
        addRect(400, 250, 200, 40, "brick");
        addLucky(1300, 200);
        addEnemy(1500, 360);
        addRect(2400, 100, 20, 300, "goal");
    } else {
        // BOSS FIGHT ARENA
        worldWidth = 800;
        addRect(0, 400, 800, 50, "ground");
        enemies.push({ x: 600, y: 300, w: 80, h: 100, vx: -4, type: "boss", hp: 5, startX: 600 });
    }
}

function addRect(x, y, w, h, type) { platforms.push({x, y, w, h, type}); }
function addLucky(x, y) { luckyBlocks.push({x, y, w: 40, h: 40, used: false}); }
function addEnemy(x, y) { enemies.push({x, y, w: 40, h: 40, vx: -2, startX: x, range: 200}); }

// --- HANG EFFEKTEK ---
const audio = new (window.AudioContext || window.webkitAudioContext)();
function playSfx(freq, type, dur) {
    const o = audio.createOscillator(), g = audio.createGain();
    o.type = type; o.frequency.value = freq;
    o.connect(g); g.connect(audio.destination);
    g.gain.setValueAtTime(0.1, audio.currentTime);
    o.start(); o.stop(audio.currentTime + dur);
}

// --- IRÁNYÍTÁS ---
const keys = {};
window.onkeydown = e => { keys[e.code] = true; if(audio.state==='suspended') audio.resume(); };
window.onkeyup = e => keys[e.code] = false;

function startGame() {
    document.getElementById("start-screen").style.display = "none";
    setupLevel(1);
    gameRunning = true;
    loop();
}

// --- FŐ CIKLUS ---
function update() {
    if (!gameRunning) return;

    // Mozgás
    if (keys["ArrowRight"]) { player.vx = player.speed; player.facing = 1; }
    else if (keys["ArrowLeft"]) { player.vx = -player.speed; player.facing = -1; }
    else { player.vx = 0; }

    if (keys["Space"] && !player.jumping) {
        player.vy = -16; player.jumping = true;
        playSfx(400, 'square', 0.1);
    }

    // Tűzgolyó
    if (keys["KeyF"] && player.power) {
        if (player.fireballs.length < 3) {
            player.fireballs.push({x: player.x + 20, y: player.y + 10, vx: player.facing * 8, vy: 2});
            playSfx(600, 'sine', 0.1);
        }
        keys["KeyF"] = false;
    }

    player.vy += 0.8; // Gravitáció
    player.x += player.vx;
    player.y += player.vy;

    // Kamera követés (megáll a pálya végén)
    cameraX = player.x - 200;
    if (cameraX < 0) cameraX = 0;
    if (cameraX > worldWidth - 800) cameraX = worldWidth - 800;

    // --- ÜTKÖZÉSEK ---
    player.jumping = true;
    platforms.forEach(p => {
        if (checkRect(player, p)) {
            if (p.type === "goal") {
                nextLevel();
            } else if (player.vy > 0 && player.y < p.y) {
                player.jumping = false; player.y = p.y - player.h; player.vy = 0;
            } else if (player.vy < 0 && player.y > p.y) {
                player.y = p.y + p.h; player.vy = 0;
            }
        }
    });

    // Szerencseblokk
    luckyBlocks.forEach(b => {
        if (checkRect(player, b) && player.vy < 0 && player.y > b.y) {
            if (!b.used) {
                b.used = true;
                fireFlowers.push({x: b.x + 5, y: b.y - 40, w: 30, h: 30});
                playSfx(500, 'sawtooth', 0.2);
            }
            player.vy = 2;
        }
    });

    // Powerup felvétel
    fireFlowers.forEach((f, i) => {
        if (checkRect(player, f)) {
            player.power = true;
            fireFlowers.splice(i, 1);
            playSfx(800, 'sine', 0.3);
        }
    });

    // Ellenségek
    enemies.forEach((en, i) => {
        en.x += en.vx;
        if (en.type !== "boss" && Math.abs(en.x - en.startX) > 200) en.vx *= -1;
        if (en.type === "boss" && (en.x < 100 || en.x > 650)) en.vx *= -1;

        if (checkRect(player, en)) {
            if (player.vy > 0 && player.y < en.y) {
                if (en.type === "boss") {
                    en.hp--; player.vy = -12;
                    if (en.hp <= 0) winGame();
                } else {
                    enemies.splice(i, 1); player.vy = -12; score += 100;
                }
            } else {
                takeDamage();
            }
        }
    });

    // Tűzgolyók mozgatása
    player.fireballs.forEach((fb, i) => {
        fb.x += fb.vx;
        enemies.forEach((en, ei) => {
            if (checkRect(fb, en)) {
                if (en.type === "boss") en.hp -= 0.5;
                else enemies.splice(ei, 1);
                player.fireballs.splice(i, 1);
                score += 50;
            }
        });
        if (fb.x < cameraX || fb.x > cameraX + 800) player.fireballs.splice(i, 1);
    });

    if (player.y > 500) takeDamage();
}

function checkRect(a, b) { return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

function takeDamage() {
    lives--;
    playSfx(150, 'square', 0.4);
    if (lives <= 0) {
        gameRunning = false;
        document.getElementById("game-over").style.display = "flex";
    } else {
        player.x = cameraX + 50; player.y = 100; player.power = false;
        document.getElementById("hp").innerText = lives;
    }
}

function nextLevel() {
    currentLevel++;
    if (currentLevel > 3) winGame();
    else setupLevel(currentLvl = currentLevel);
}

function winGame() {
    gameRunning = false;
    document.getElementById("win-screen").style.display = "flex";
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-cameraX, 0);

    // Rajzolás: Felhők
    ctx.fillStyle = "rgba(255,255,255,0.5)";
    ctx.fillRect(cameraX + 100, 50, 80, 40);
    ctx.fillRect(cameraX + 400, 80, 100, 50);

    // Rajzolás: Blokkok
    platforms.forEach(p => {
        ctx.fillStyle = p.type === "ground" ? "#228b22" : (p.type === "brick" ? "#a52a2a" : "white");
        ctx.fillRect(p.x, p.y, p.w, p.h);
    });

    luckyBlocks.forEach(b => {
        ctx.fillStyle = b.used ? "#777" : "#ffd700";
        ctx.fillRect(b.x, b.y, b.w, b.h);
        if(!b.used) { ctx.fillStyle="#000"; ctx.fillText("?", b.x+15, b.y+25); }
    });

    fireFlowers.forEach(f => {
        ctx.fillStyle = "orange"; ctx.beginPath(); ctx.arc(f.x+15, f.y+15, 15, 0, 7); ctx.fill();
    });

    enemies.forEach(en => {
        ctx.fillStyle = en.type === "boss" ? "purple" : "#8b4513";
        ctx.fillRect(en.x, en.y, en.w, en.h);
    });

    player.fireballs.forEach(fb => {
        ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(fb.x, fb.y, 8, 0, 7); ctx.fill();
    });

    // Játékos rajzolása (Animált hatás nélkül is látszik az irány)
    ctx.fillStyle = player.power ? "white" : "red";
    ctx.fillRect(player.x, player.y, player.w, player.h);
    ctx.fillStyle = "black";
    let eyeX = player.facing === 1 ? player.x + 22 : player.x + 5;
    ctx.fillRect(eyeX, player.y + 10, 8, 8);

    ctx.restore();
    document.getElementById("score").innerText = score;
}

function loop() {
    update();
    draw();
    if (gameRunning) requestAnimationFrame(loop);
}
</script>
</body>
</html>
