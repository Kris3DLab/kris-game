<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szuper Mario - Pro Kiadás</title>
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #wrapper { position: relative; border: 6px solid #444; border-radius: 12px; box-shadow: 0 0 50px rgba(0,0,0,0.7); overflow: hidden; }
        canvas { display: block; background: linear-gradient(#5c94fc, #bde0ff); }
        
        /* UI */
        #ui { position: absolute; top: 10px; left: 15px; right: 15px; display: flex; justify-content: space-between; color: #fff; font-size: 22px; font-weight: bold; text-shadow: 2px 2px #000; pointer-events: none; z-index: 10; }
        .screen { position: absolute; inset: 0; background: rgba(0,0,0,0.75); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 20; text-align: center; backdrop-filter: blur(4px); }
        h1 { font-size: 55px; margin: 0; color: #ff4500; text-shadow: 3px 3px #fff; }
        button { padding: 12px 35px; font-size: 22px; cursor: pointer; background: #e52521; color: white; border: 3px solid #fff; border-radius: 30px; margin-top: 15px; font-weight: bold; transition: 0.2s; }
        button:hover { transform: scale(1.1); background: #ff4500; }
    </style>
</head>
<body>

<div id="wrapper">
    <div id="ui">
        <div>SZINT: <span id="lvlDisplay">1</span></div>
        <div id="powerLabel" style="color: #ffff00; text-transform: uppercase;"></div>
        <div>ÉLET: <span id="hpDisplay">3</span> | PONT: <span id="scDisplay">0</span></div>
    </div>

    <div id="menu" class="screen">
        <h1>KRIS GAME</h1>
        <p>A Teljes Magyar Kaland</p>
        <button onclick="startGame()">JÁTÉK INDÍTÁSA</button>
    </div>

    <div id="fail" class="screen" style="display:none">
        <h1>MEGHALTÁL</h1>
        <button onclick="location.reload()">ÚJRAPRÓBÁLÁS</button>
    </div>

    <div id="victory" class="screen" style="display:none">
        <h1 style="color: gold;">GYŐZELEM!</h1>
        <p>Mindenkit legyőztél!</p>
        <button onclick="location.reload()">ÚJ JÁTÉK</button>
    </div>

    <canvas id="c" width="840" height="480"></canvas>
</div>

<script>
const canvas = document.getElementById("c"), ctx = canvas.getContext("2d");
let active = false, currentLvl = 1, score = 0, hp = 3, cameraX = 0, frame = 0;

// --- JÁTÉKOS ADATOK ---
const mario = {
    x: 80, y: 300, w: 38, h: 54, vx: 0, vy: 0, 
    onGround: false, dir: 1, power: false, fireballs: []
};

let platforms = [], enemies = [], items = [], scenery = [];

// --- GRAFIKA ÉS SZINTEK ---
function buildLevel(n) {
    platforms = []; enemies = []; items = []; scenery = [];
    mario.x = 80; mario.y = 300; cameraX = 0;
    document.getElementById("lvlDisplay").innerText = n;

    // Dekoráció (Parallaxis)
    for(let i=0; i<15; i++) scenery.push({x: i*600, y: 50 + Math.random()*100, s: 0.3 + Math.random()*0.4});

    // FIXÁLT TALAJ
    platforms.push({x: 0, y: 430, w: 4000, h: 50, type: 'grass'});

    if (n === 1) {
        // Blokkok elérhető magasságban (280-320px közötti Y az ideális)
        addB(450, 290, 'lucky');
        addB(650, 290, 'brick');
        addB(690, 290, 'lucky');
        addB(730, 290, 'brick');
        addEnemy(800, 390);
        addEnemy(1200, 390);
        platforms.push({x: 2500, y: 100, w: 40, h: 330, type: 'goal'});
    } else if (n === 2) {
        platforms = [{x: 0, y: 430, w: 1000, h: 50, type: 'grass'}, 
                     {x: 1200, y: 430, w: 1500, h: 50, type: 'grass'}]; // Szakadék
        addB(1050, 320, 'brick'); // Segítő platform a szakadék felett
        addB(1400, 260, 'lucky');
        addEnemy(1600, 390);
        platforms.push({x: 2600, y: 100, w: 40, h: 330, type: 'goal'});
    } else {
        // BOSS LEVEL
        platforms = [{x: 0, y: 430, w: 1000, h: 50, type: 'grass'}];
        enemies.push({x: 700, y: 330, w: 100, h: 100, vx: -4.5, hp: 6, type: 'boss', startX: 700});
    }
}

function addB(x, y, t) { platforms.push({x, y, w: 40, h: 40, type: t, used: false}); }
function addEnemy(x, y) { enemies.push({x, y, w: 42, h: 42, vx: -3, startX: x, range: 250}); }

// --- HANGOK ---
const audio = new (window.AudioContext || window.webkitAudioContext)();
function playSfx(f, t, d) {
    const o = audio.createOscillator(), g = audio.createGain();
    o.type = t; o.frequency.value = f;
    o.connect(g); g.connect(audio.destination);
    g.gain.setValueAtTime(0.08, audio.currentTime);
    o.start(); o.stop(audio.currentTime + d);
}

// --- IRÁNYÍTÁS ---
const keys = {};
window.onkeydown = e => { keys[e.code] = true; if(audio.state==='suspended') audio.resume(); };
window.onkeyup = e => keys[e.code] = false;

function startGame() {
    document.getElementById("menu").style.display = "none";
    buildLevel(1); active = true; loop();
}

function update() {
    if (!active) return;
    frame++;

    // Mozgás finomítás
    if (keys["ArrowRight"]) { mario.vx = 6.5; mario.dir = 1; }
    else if (keys["ArrowLeft"]) { mario.vx = -6.5; mario.dir = -1; }
    else { mario.vx *= 0.8; }

    if (keys["Space"] && mario.onGround) {
        mario.vy = -18.5; mario.onGround = false;
        playSfx(440, 'square', 0.1);
    }

    // Tűzgolyó (F gomb)
    if (keys["KeyF"] && mario.power) {
        if(mario.fireballs.length < 4) {
            mario.fireballs.push({x: mario.x+20, y: mario.y+20, vx: mario.dir*12, vy: 3});
            playSfx(600, 'sine', 0.1);
        }
        keys["KeyF"] = false;
    }

    mario.vy += 0.95; // Erősebb gravitáció a "súlyosabb" érzetért
    mario.x += mario.vx; mario.y += mario.vy;

    // Kamera követés
    cameraX = Math.max(0, mario.x - 300);

    // Ütközés és Fizika
    mario.onGround = false;
    platforms.forEach(b => {
        if (mario.x < b.x+b.w && mario.x+mario.w > b.x && mario.y < b.y+b.h && mario.y+mario.h > b.y) {
            if (b.type === 'goal') nextLvl();
            else if (mario.vy > 0 && mario.y < b.y) { 
                mario.y = b.y - mario.h; mario.vy = 0; mario.onGround = true; 
            }
            else if (mario.vy < 0 && mario.y > b.y) {
                mario.y = b.y + b.h; mario.vy = 2;
                if (b.type === 'lucky' && !b.used) {
                    b.used = true; items.push({x: b.x+5, y: b.y-45, w: 30, h: 30});
                    playSfx(550, 'sawtooth', 0.2);
                }
            }
        }
    });

    items.forEach((it, i) => {
        if (mario.x < it.x+it.w && mario.x+mario.w > it.x && mario.y < it.y+it.h && mario.y+mario.h > it.y) {
            mario.power = true; items.splice(i, 1);
            document.getElementById("powerLabel").innerText = "Tűz Mario!";
            playSfx(880, 'sine', 0.3);
        }
    });

    enemies.forEach((en, i) => {
        en.x += en.vx;
        if (en.type !== 'boss' && Math.abs(en.x - en.startX) > en.range) en.vx *= -1;
        if (en.type === 'boss' && (en.x < 100 || en.x > 800)) en.vx *= -1;

        if (mario.x < en.x+en.w && mario.x+mario.w > en.x && mario.y < en.y+en.h && mario.y+mario.h > en.y) {
            if (mario.vy > 0 && mario.y < en.y + 10) {
                if(en.type==='boss') { en.hp--; mario.vy = -16; if(en.hp<=0) win(); playSfx(150, 'sawtooth', 0.2); }
                else { enemies.splice(i, 1); mario.vy = -13; score += 150; playSfx(200, 'sine', 0.1); }
            } else die();
        }
    });

    mario.fireballs.forEach((fb, i) => {
        fb.x += fb.vx; fb.y += fb.vy;
        if (fb.y > 410) fb.vy = -Math.abs(fb.vy); // Pattog a földön
        enemies.forEach((en, ei) => {
            if (fb.x < en.x+en.w && fb.x > en.x && fb.y < en.y+en.h && fb.y > en.y) {
                if(en.type==='boss') { en.hp -= 0.5; fb.x = -9999; }
                else { enemies.splice(ei, 1); fb.x = -9999; score += 100; }
            }
        });
        if(fb.x < cameraX || fb.x > cameraX + 850) mario.fireballs.splice(i, 1);
    });

    if (mario.y > 500) die();
}

function die() {
    hp--; document.getElementById("hpDisplay").innerText = hp;
    playSfx(100, 'square', 0.4);
    if (hp <= 0) { active = false; document.getElementById("fail").style.display = "flex"; }
    else { mario.x = cameraX + 50; mario.y = 100; mario.power = false; document.getElementById("powerLabel").innerText = ""; }
}

function nextLvl() { currentLvl++; if(currentLvl > 3) win(); else buildLevel(currentLvl); }
function win() { active = false; document.getElementById("victory").style.display = "flex"; }

function render() {
    ctx.clearRect(0, 0, 840, 480);
    
    // Parallaxis felhők
    ctx.fillStyle = "rgba(255,255,255,0.6)";
    scenery.forEach(s => { ctx.fillRect(s.x - cameraX * s.s, s.y, 70, 35); });

    ctx.save(); ctx.translate(-cameraX, 0);

    // Platformok rajzolása
    platforms.forEach(b => {
        if (b.type === 'grass') {
            ctx.fillStyle = "#8b4513"; ctx.fillRect(b.x, b.y, b.w, b.h);
            ctx.fillStyle = "#228b22"; ctx.fillRect(b.x, b.y, b.w, 15);
        } else if (b.type === 'brick') {
            ctx.fillStyle = "#a52a2a"; ctx.fillRect(b.x, b.y, b.w, b.h);
            ctx.strokeStyle = "#5d1a1a"; ctx.strokeRect(b.x+3, b.y+3, b.w-6, b.h-6);
        } else if (b.type === 'lucky') {
            let glow = 180 + Math.sin(frame*0.1)*75;
            ctx.fillStyle = `rgb(${glow}, ${glow*0.8}, 0)`; ctx.fillRect(b.x, b.y, b.w, b.h);
            if(!b.used) { ctx.fillStyle = "#fff"; ctx.font = "bold 25px Arial"; ctx.fillText("?", b.x+13, b.y+30); }
        } else if (b.type === 'goal') {
            ctx.fillStyle = "#fff"; ctx.fillRect(b.x, b.y, b.w, b.h);
            ctx.fillStyle = "red"; ctx.fillRect(b.x-10, b.y + 20 + Math.sin(frame*0.05)*20, 60, 30);
        }
    });

    items.forEach(it => {
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(it.x+15, it.y+15, 15, 0, 7); ctx.fill();
        ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(it.x+15, it.y+15, 8, 0, 7); ctx.fill();
    });

    enemies.forEach(en => {
        ctx.fillStyle = en.type === 'boss' ? "#4b0082" : "#8b4513";
        ctx.fillRect(en.x, en.y, en.w, en.h);
        ctx.fillStyle = "white"; ctx.fillRect(en.x + (en.vx > 0 ? 30 : 5), en.y + 10, 10, 10);
    });

    mario.fireballs.forEach(fb => {
        ctx.fillStyle = "orange"; ctx.beginPath(); ctx.arc(fb.x, fb.y, 8, 0, 7); ctx.fill();
    });

    // MARIO RAJZOLÁSA (Animált színekkel)
    ctx.fillStyle = mario.power ? "#fff" : "#e52521";
    ctx.fillRect(mario.x, mario.y, mario.w, mario.h);
    ctx.fillStyle = mario.power ? "#e52521" : "#0055ff";
    ctx.fillRect(mario.x, mario.y + 32, mario.w, 22); // Nadrág
    ctx.fillStyle = "#ffccaa"; ctx.fillRect(mario.x+8, mario.y+5, 22, 22); // Arc
    ctx.fillStyle = "black"; ctx.fillRect(mario.dir === 1 ? mario.x+24 : mario.x+6, mario.y+12, 8, 8); // Szem

    ctx.restore();
    document.getElementById("scDisplay").innerText = score;
}

function loop() {
    if (!active) return;
    update();
    render();
    requestAnimationFrame(loop);
}
</script>
</body>
</html>
