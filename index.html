<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïπÔ∏è KRIS SUPER MARIO - NERFED BOSS (NO CHASE) üèÜ</title>
    <style>
        * { box-sizing: border-box; margin:0; padding:0; }
        body { 
            background: linear-gradient(180deg, #87CEEB 0%, #98D8E8 50%, #E0F6FF 100%);
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, sans-serif; overflow: hidden;
        }
        #wrapper {
            position: relative; border: 10px solid #444; border-radius: 25px;
            box-shadow: 0 0 80px rgba(0,0,0,0.9), inset 0 0 30px rgba(255,255,255,0.15);
            overflow: hidden; max-width: 95vw; max-height: 95vh;
        }
        canvas { 
            display: block; width: 100%; height: 100%;
            image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;
        }
        #ui {
            position: absolute; top: 20px; left: 25px; right: 25px; z-index: 15;
            display: flex; justify-content: space-between; align-items: center;
            color: white; font-size: 26px; font-weight: 900; text-shadow: 4px 4px 0 #000;
            background: rgba(0,0,0,0.5); padding: 15px 30px; border-radius: 25px;
            backdrop-filter: blur(20px); border: 3px solid rgba(255,255,255,0.3);
            pointer-events: none;
        }
        #hearts { font-size: 32px; }
        #powerLabel { color: #ffff00; font-size: 22px; }
        .screen {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; z-index: 25; text-align: center; backdrop-filter: blur(20px);
        }
        h1 { font-size: clamp(50px, 10vw, 90px); margin: 0 0 20px;
             background: linear-gradient(45deg, #ff4500, #ff8c00, #ffd700);
             -webkit-background-clip: text; -webkit-text-fill-color: transparent;
             text-shadow: 5px 5px #000; font-weight: 900; }
        p { font-size: clamp(20px, 4vw, 28px); margin: 10px 0 30px; }
        button {
            padding: 18px 50px; font-size: 26px; cursor: pointer;
            background: linear-gradient(45deg, #e52521, #ff4500);
            color: white; border: 5px solid white; border-radius: 50px;
            font-weight: bold; transition: all 0.3s;
        }
        button:hover { transform: scale(1.15); background: #ff8c00; }
    </style>
</head>
<body>
<div id="wrapper">
    <div id="ui">
        <div>SZINT: <span id="lvlDisplay">1</span></div>
        <div id="powerLabel"></div>
        <div id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div>PONT: <span id="scDisplay">0</span></div>
    </div>

    <div id="menu" class="screen">
        <h1>KRIS SUPER MARIO</h1>
        <p>IR√ÅNY√çT√ÅS: nyilak ‚Ä¢ SPACE ugr√°s ‚Ä¢ F t≈±zgoly√≥</p>
        <button id="startBtn">J√ÅT√âK IND√çT√ÅSA</button>
    </div>

    <div id="fail" class="screen" style="display:none">
        <h1>GAME OVER</h1>
        <button onclick="location.reload()">√öJRA PR√ìB√ÅLOM</button>
    </div>

    <div id="victory" class="screen" style="display:none">
        <h1>GRATUL√ÅLOK! GY≈êZT√âL!</h1>
        <button onclick="location.reload()">√öJ J√ÅT√âK</button>
    </div>

    <canvas id="c"></canvas>
</div>

<script>
// ==================== JAVASCRIPT R√âSZ ====================

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
canvas.width = 960;
canvas.height = 576;
ctx.imageSmoothingEnabled = false;

let active = false;
let currentLvl = 1;
let score = 0;
let hp = 3;
let cameraX = 0;
let targetCameraX = 0;
let frame = 0;

const mario = {
    x: 120, y: 380, w: 40, h: 56,
    vx: 0, vy: 0, onGround: false, dir: 1,
    power: false, fireballs: [],
    fireCooldown: 0,   // ‚Üê √∫j: t≈±zgoly√≥ cooldown
    animFrame: 0
};

let platforms = [];
let enemies = [];
let items = [];
let clouds = [];
let hills = [];
let bossFireballs = [];

let audioCtx;
function initAudio() {
    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    catch(e) {}
}
function playSfx(freq, type='square', duration=0.12, volume=0.12) {
    if (!audioCtx) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(volume, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    } catch(e) {}
}
initAudio();

function buildLevel(n) {
    platforms = []; enemies = []; items = []; clouds = []; hills = []; bossFireballs = [];
    mario.x = 120; mario.y = 380; mario.power = false; mario.fireballs = [];
    mario.fireCooldown = 0;
    cameraX = targetCameraX = 0;
    document.getElementById('powerLabel').innerText = '';
    document.getElementById('lvlDisplay').innerText = n;
    updateHearts();

    // parallax h√°tt√©r
    for(let i = 0; i < 35; i++) {
        clouds.push({x: i*420 + Math.random()*450, y: 70 + Math.random()*130,
                     size: 45 + Math.random()*55, speed: 0.2 + Math.random()*0.4});
    }
    for(let i = 0; i < 22; i++) {
        hills.push({x: i*580 + Math.random()*420, w: 240 + Math.random()*220,
                    h: 55 + Math.random()*60, speed: 0.35 + Math.random()*0.45});
    }

    platforms.push({x:0, y:488, w:7000, h:88, type:'ground'});

    if (n === 1) {
        for(let i = 450; i < 1200; i += 55) {
            addBlock(i, 368, Math.random() > 0.4 ? 'brick' : 'lucky');
        }
        addPipe(1350);
        addEnemy(650,448); addEnemy(950,448); addEnemy(1400,448);
        addEnemy(1700,448); addEnemy(2000,448);
        platforms.push({x:3200, y:140, w:60, h:348, type:'goal'});
    }
    else if (n === 2) {
        platforms = [
            {x:0,   y:488, w:1300, h:88, type:'ground'},
            {x:1680,y:488, w:2800, h:88, type:'ground'}
        ];
        for(let py=420, px=1100; py>260; py-=40, px+=60) {
            addBlock(px, py, 'brick');
        }
        addBlock(1480,300,'lucky');
        addPipe(1950);
        addEnemy(1820,448); addEnemy(2120,448); addEnemy(2420,448);
        addEnemy(2720,448); addEnemy(3020,448);
        platforms.push({x:3800, y:140, w:60, h:348, type:'goal'});
    }
    else {  // BOSS SZINT ‚Äì NERFELT, NEM K√ñVET, CSAK PATROL + RITK√ÅN L≈ê/UGr
        platforms = [{x:0,y:488,w:4000,h:88,type:'ground'}];
        addBlock(950,428,'brick');
        addBlock(1010,368,'brick');
        addBlock(1070,308,'brick');
        addBlock(1130,248,'lucky');

        enemies.push({
            x: 1850, y: 368, w: 140, h: 140,
            vx: -4, vy: 0, hp: 10, maxHp: 10, type: 'boss',
            patrolMin: 1450, patrolMax: 2850,
            fireCooldown: 0, jumpCooldown: 0,
            onGround: true, animFrame: 0
        });
    }
}

function addBlock(x, y, type) {
    platforms.push({x, y, w:52, h:52, type, used: false});
}

function addPipe(x) {
    platforms.push({x:x-15, y:488, w:82, h:70, type:'pipe_bottom'});
    platforms.push({x:x-15, y:358, w:82, h:130, type:'pipe'});
}

function addEnemy(x, y) {
    enemies.push({
        x, y, w:46, h:46,
        vx: -3.5 + Math.random()*1,
        patrolMin: x-220, patrolMax: x+220,
        type: 'goomba'
    });
}

function updateHearts() {
    let str = '';
    for(let i = 0; i < 3; i++) str += (i < hp) ? '‚ù§Ô∏è' : 'üñ§';
    document.getElementById('hearts').innerHTML = str;
}

const keys = {};
window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if (e.code === 'Space') e.preventDefault();
});
window.addEventListener('keyup', e => keys[e.code] = false);

document.getElementById('startBtn').addEventListener('click', () => {
    document.getElementById('menu').style.display = 'none';
    buildLevel(1);
    active = true;
    score = 0;
    hp = 3;
    updateHearts();
    requestAnimationFrame(loop);
});

function update() {
    if (!active) return;
    frame++;
    mario.animFrame = (mario.animFrame + 1) % 60;

    // Mario mozg√°s
    const acc = 1.0;
    const maxVx = mario.power ? 9.5 : 8.2;
    if (keys['ArrowRight']) { mario.vx = Math.min(mario.vx + acc, maxVx); mario.dir = 1; }
    else if (keys['ArrowLeft'])  { mario.vx = Math.max(mario.vx - acc, -maxVx); mario.dir = -1; }
    else mario.vx *= 0.83;

    if (keys['Space'] && mario.onGround) {
        mario.vy = -19.8;
        mario.onGround = false;
        playSfx(659, 'sine', 0.18);
    }

    // T≈±zgoly√≥ cooldown (0.5 mp ‚âà 30 frame 60fps-en)
    if (mario.fireCooldown > 0) mario.fireCooldown--;
    if (keys['KeyF'] && mario.power && mario.fireCooldown <= 0 && mario.fireballs.length < 6) {
        mario.fireballs.push({
            x: mario.x + (mario.dir > 0 ? 38 : -12),
            y: mario.y + 32,
            vx: mario.dir * 15.5,
            vy: -2.5 + Math.random() * 4
        });
        playSfx(784, 'sawtooth', 0.1);
        mario.fireCooldown = 30;   // ‚Üê 0.5 m√°sodperc cooldown
    }

    mario.vy += 1.05;
    mario.x += mario.vx;
    mario.y += mario.vy;

    // Kamera
    targetCameraX = Math.max(0, Math.min(7200 - 960, mario.x - 480));
    cameraX += (targetCameraX - cameraX) * 0.17;

    // Parallax
    clouds.forEach(c => {
        c.x -= c.speed * 0.7;
        if (c.x + c.size < cameraX - 400) c.x += 3400;
    });
    hills.forEach(h => {
        h.x -= h.speed * 1.35;
        if (h.x + h.w < cameraX - 500) h.x += 3800;
    });

    // √útk√∂z√©s platformokkal (jav√≠tott)
    mario.onGround = false;
    platforms.forEach(p => {
        if (mario.x + mario.w > p.x && mario.x < p.x + p.w &&
            mario.y + mario.h > p.y && mario.y < p.y + p.h) {
            // f√∂ld√∂n landol√°s
            if (mario.vy >= 0 && mario.y + mario.h - mario.vy <= p.y) {
                mario.y = p.y - mario.h;
                mario.vy = 0;
                mario.onGround = true;
            }
            // fejjel √ºtk√∂z√©s
            else if (mario.vy < 0 && mario.y - mario.vy >= p.y + p.h) {
                mario.y = p.y + p.h;
                mario.vy = 0;
                if (p.type === 'lucky' && !p.used) {
                    p.used = true;
                    items.push({x: p.x + 16, y: p.y - 55, type: 'mushroom'});
                    playSfx(880, 'sine', 0.3);
                }
            }
            // oldals√≥ fal
            else if (mario.vx > 0) {
                mario.x = p.x - mario.w;
                mario.vx = 0;
            }
            else if (mario.vx < 0) {
                mario.x = p.x + p.w;
                mario.vx = 0;
            }
            if (p.type === 'goal') nextLvl();
        }
    });

    // Items
    items = items.filter(it => {
        it.y += 1.0;
        if (mario.x + mario.w > it.x && mario.x < it.x + 40 &&
            mario.y + mario.h > it.y && mario.y < it.y + 40) {
            mario.power = true;
            document.getElementById('powerLabel').innerText = 'T≈∞Z MARIO!';
            playSfx(1047, 'sine', 0.4);
            return false;
        }
        return it.y < 520;
    });

    // Ellens√©gek mozg√°sa
    enemies.forEach(en => {
        if (en.type !== 'boss') {
            en.x += en.vx;
            if (en.x < en.patrolMin || en.x > en.patrolMax) en.vx *= -1;
        } else {
            // NERF: csak patrol, lassabb sebess√©g, ritk√°bb t≈±z/ugr√°s
            en.x += en.vx;
            if (en.x < en.patrolMin || en.x > en.patrolMax) en.vx *= -1;

            if (en.fireCooldown <= 0 && Math.random() < 0.008) { // ritk√°bb t≈±z
                bossFireballs.push({
                    x: en.x + (en.vx > 0 ? en.w : 0),
                    y: en.y + 60,
                    vx: en.vx > 0 ? 9 : -9,
                    vy: 3 + Math.random()*3
                });
                en.fireCooldown = 240; // kb. 4 m√°sodperc
                playSfx(180, 'sawtooth', 0.35);
            }

            if (en.jumpCooldown <= 0 && Math.random() < 0.007 && en.onGround) {
                en.vy = -14; // kisebb ugr√°s
                en.jumpCooldown = 300; // ritk√°bb
                playSfx(110, 'sawtooth', 0.4);
            }

            en.fireCooldown = Math.max(0, en.fireCooldown - 1);
            en.jumpCooldown = Math.max(0, en.jumpCooldown - 1);

            en.vy += 1.05;
            en.y += en.vy;

            // boss f√∂ld√∂n landol√°s
            let bossGround = false;
            platforms.forEach(p => {
                if (en.x + en.w > p.x && en.x < p.x + p.w &&
                    en.y + en.h > p.y && en.y < p.y + p.h &&
                    en.vy >= 0 && en.y + en.h - en.vy <= p.y) {
                    en.y = p.y - en.h;
                    en.vy = 0;
                    bossGround = true;
                }
            });
            if (en.y > 650) { en.y = 368; en.vy = 0; }
        }
    });

    // Mario ‚Üî ellens√©g √ºtk√∂z√©s
    for (let i = enemies.length - 1; i >= 0; i--) {
        const en = enemies[i];
        if (mario.x + mario.w > en.x && mario.x < en.x + en.w &&
            mario.y + mario.h > en.y && mario.y < en.y + en.h) {
            if (mario.vy > 0.5 && mario.y < en.y + 25) {
                // stomp
                if (en.type === 'boss') {
                    en.hp -= 2;
                    mario.vy = -17;
                    playSfx(150, 'sawtooth', 0.25);
                    if (en.hp <= 0) {
                        score += 12000;
                        win();
                        return;
                    }
                } else {
                    enemies.splice(i, 1);
                    mario.vy = -15;
                    score += 300;
                    playSfx(200, 'sine', 0.2);
                }
            } else {
                die();
            }
        }
    }

    // Mario t≈±zgoly√≥i
    mario.fireballs = mario.fireballs.filter(fb => {
        fb.x += fb.vx;
        fb.y += fb.vy;
        fb.vy += 0.72;
        if (fb.y > 470) fb.vy *= -0.7;

        for (let i = 0; i < enemies.length; i++) {
            const en = enemies[i];
            if (fb.x + 20 > en.x && fb.x < en.x + en.w &&
                fb.y + 20 > en.y && fb.y < en.y + en.h) {
                if (en.type === 'boss') {
                    en.hp -= 2;
                    playSfx(320, 'sawtooth', 0.15);
                } else {
                    enemies.splice(i, 1);
                    score += 200;
                }
                return false;
            }
        }
        return fb.x > cameraX - 200 && fb.x < cameraX + 1200;
    });

    // Boss t≈±zgoly√≥i
    bossFireballs = bossFireballs.filter(fb => {
        fb.x += fb.vx;
        fb.y += fb.vy;
        fb.vy += 0.8;
        if (fb.y > 500) return false;

        if (fb.x + 24 > mario.x && fb.x < mario.x + mario.w &&
            fb.y + 24 > mario.y && fb.y < mario.y + mario.h) {
            die();
            return false;
        }
        return fb.x > cameraX - 200 && fb.x < cameraX + 1200;
    });

    if (mario.y > 680) die();

    document.getElementById('scDisplay').innerText = score;
}

function die() {
    playSfx(82, 'square', 0.7, 0.28);
    hp--;
    updateHearts();
    if (hp <= 0) {
        active = false;
        setTimeout(() => document.getElementById('fail').style.display = 'flex', 400);
    } else {
        mario.x = 160;
        mario.y = 380;
        mario.vx = mario.vy = 0;
        mario.power = false;
        mario.fireballs = [];
        mario.fireCooldown = 0;
        document.getElementById('powerLabel').innerText = '';
        cameraX = targetCameraX = 0;
    }
}

function nextLvl() {
    currentLvl++;
    if (currentLvl > 3) win();
    else {
        playSfx(1319, 'sine', 0.6);
        buildLevel(currentLvl);
    }
}

function win() {
    active = false;
    score += 25000;
    setTimeout(() => document.getElementById('victory').style.display = 'flex', 800);
    playSfx(988, 'sine', 1.2);
}

// RENDER
function render() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 1. T√°voli parallax (felh≈ëk)
    ctx.save();
    ctx.translate(-cameraX * 0.18, 0);
    clouds.forEach(c => {
        ctx.fillStyle = `rgba(255,255,255,${0.65 + Math.sin(frame*0.03 + c.x*0.01)*0.18})`;
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.size/2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath();
        ctx.arc(c.x - c.size/3.5, c.y - 10, c.size/3.8, 0, Math.PI*2); ctx.fill();
        ctx.beginPath();
        ctx.arc(c.x + c.size/3.2, c.y - 6, c.size/2.6, 0, Math.PI*2); ctx.fill();
    });
    ctx.restore();

    // 2. K√∂zeli dombok
    ctx.save();
    ctx.translate(-cameraX * 0.52, 0);
    hills.forEach(h => {
        ctx.fillStyle = '#32cd32';
        ctx.strokeStyle = '#228b22';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(h.x, 488);
        ctx.quadraticCurveTo(h.x + h.w/2, 488 - h.h, h.x + h.w, 488);
        ctx.fill();
        ctx.stroke();
    });
    ctx.restore();

    ctx.save();
    ctx.translate(-cameraX, 0);

    // Platformok
    platforms.forEach(p => {
        const px = p.x, py = p.y;
        if (p.type === 'ground') {
            ctx.fillStyle = '#8b4513'; ctx.fillRect(px, py, p.w, p.h);
            ctx.fillStyle = '#228b22'; ctx.fillRect(px, py, p.w, 24);
            ctx.fillStyle = '#006400';
            for (let i = 0; i < p.w; i += 12) {
                ctx.fillRect(px + i, py - 6 + Math.sin(frame * 0.15 + i * 0.1) * 3, 6, 15);
            }
        } else if (p.type === 'brick') {
            ctx.fillStyle = '#cd853f'; ctx.fillRect(px, py, p.w, p.h);
            ctx.strokeStyle = '#8b4513'; ctx.lineWidth = 3;
            ctx.strokeRect(px + 6, py + 6, p.w - 12, p.h - 12);
        } else if (p.type === 'lucky') {
            const g = 220 + Math.sin(frame * 0.25) * 70;
            ctx.shadowColor = `hsl(${g/2},100%,55%)`;
            ctx.shadowBlur = 25;
            ctx.fillStyle = `hsl(${g/2.5},100%,48%)`;
            ctx.fillRect(px, py, p.w, p.h);
            ctx.shadowBlur = 0;
            ctx.fillStyle = 'white';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('?', px + 26, py + 26);
        } else if (p.type === 'pipe' || p.type === 'pipe_bottom') {
            ctx.fillStyle = p.type === 'pipe' ? '#006400' : '#004d00';
            ctx.fillRect(px, py, p.w, p.h);
            ctx.fillStyle = '#228b22';
            ctx.fillRect(px + 12, py + (p.type==='pipe'?8:-12), p.w - 24, p.h - (p.type==='pipe'?16:0) + 20);
        } else if (p.type === 'goal') {
            ctx.fillStyle = '#a52a2a'; ctx.fillRect(px - 25, py, 25, p.h);
            const wv = Math.sin(frame * 0.25) * 25;
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.moveTo(px, py + 50);
            ctx.quadraticCurveTo(px - 65, py + 50 + wv, px - 55, py + 80 + wv * 0.7);
            ctx.lineTo(px, py + 95);
            ctx.fill();
        }
    });

    // Items (gomba)
    items.forEach(it => {
        ctx.save();
        ctx.shadowColor = '#ff6666';
        ctx.shadowBlur = 18;
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.ellipse(it.x + 20, it.y + 20, 20, 15, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#ff4444';
        ctx.beginPath();
        ctx.ellipse(it.x + 20, it.y + 20, 14, 11, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = 'white';
        ctx.fillRect(it.x + 16, it.y + 31, 12, 20);
        ctx.restore();
    });

    // Ellens√©gek ‚Äì GOOMBA r√©szletesebb
    enemies.forEach(en => {
        const ex = en.x, ey = en.y;
        if (en.type === 'goomba') {
            const bobY = Math.sin(frame * 0.4 + ex * 0.01) * 4;
            ctx.fillStyle = '#5d4037';
            ctx.fillRect(ex + 6, ey + 10 + bobY, 34, 34);
            ctx.fillStyle = '#8b7355';
            ctx.fillRect(ex + 8, ey + 12 + bobY, 30, 30);
            ctx.fillStyle = 'white';
            ctx.fillRect(ex + 12, ey + 16 + bobY, 10, 10);
            ctx.fillRect(ex + 24, ey + 16 + bobY, 10, 10);
            ctx.fillStyle = 'black';
            ctx.fillRect(ex + 15, ey + 19 + bobY, 5, 5);
            ctx.fillRect(ex + 27, ey + 19 + bobY, 5, 5);
            ctx.fillStyle = '#4a362a';
            ctx.fillRect(ex + 10, ey + 40 + bobY + Math.sin(frame*0.6)*3, 10, 16);
            ctx.fillRect(ex + 26, ey + 40 + bobY - Math.sin(frame*0.6)*3, 10, 16);
        } else {
            // BOSS ‚Äì egyszer≈±s√≠tett, nerf kin√©zet
            const bx = en.x, by = en.y;
            ctx.fillStyle = '#4b0082';
            ctx.fillRect(bx + 20, by + 40, 100, 100);
            ctx.fillStyle = '#7b2cbf';
            ctx.fillRect(bx + 30, by + 50, 80, 80);
            ctx.fillStyle = '#d2691e';
            for (let s = 0; s < 4; s++) {
                ctx.beginPath();
                ctx.moveTo(bx + 40 + s*20, by + 40);
                ctx.lineTo(bx + 50 + s*20, by + 20);
                ctx.lineTo(bx + 60 + s*20, by + 40);
                ctx.fill();
            }
            // fej
            ctx.fillStyle = '#654321';
            ctx.fillRect(bx + 80, by + 25, 40, 40);
            ctx.fillStyle = '#ff4444';
            ctx.fillRect(bx + 90, by + 35, 20, 15); // sz√°j
            // HP bar
            ctx.fillStyle = '#222';
            ctx.fillRect(bx + 20, by + 10, 100, 14);
            const hpW = 100 * (en.hp / en.maxHp);
            ctx.fillStyle = en.hp > 6 ? '#00cc44' : en.hp > 3 ? '#ffaa00' : '#ff4444';
            ctx.fillRect(bx + 20, by + 10, hpW, 14);
        }
    });

    // Boss t≈±zgoly√≥k
    bossFireballs.forEach(fb => {
        ctx.save();
        ctx.shadowColor = '#ff2200';
        ctx.shadowBlur = 25;
        ctx.fillStyle = 'rgba(255,100,0,0.7)';
        ctx.beginPath();
        ctx.arc(fb.x + 12, fb.y + 12, 16, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = '#ff4500';
        ctx.beginPath();
        ctx.arc(fb.x + 12, fb.y + 12, 10, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
    });

    // Mario t≈±zgoly√≥k
    mario.fireballs.forEach(fb => {
        ctx.save();
        ctx.shadowColor = '#ff8800';
        ctx.shadowBlur = 25;
        ctx.fillStyle = 'rgba(255,180,0,0.6)';
        ctx.beginPath();
        ctx.arc(fb.x + 10, fb.y + 10, 14, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = 'orange';
        ctx.beginPath();
        ctx.arc(fb.x + 10, fb.y + 10, 9, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
    });

    // Mario rajzol√°s
    const mx = mario.x, my = mario.y;
    const bob = (mario.onGround && Math.abs(mario.vx) > 1.5) ? Math.sin(frame * 0.55) * 5 : 0;
    const squash = Math.max(0, mario.vy * 0.1);

    ctx.fillStyle = mario.power ? '#ff8c00' : '#e31b23';
    ctx.fillRect(mx + 6, my + 4 + bob - squash, 28, 16);
    ctx.fillStyle = 'white';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('M', mx + 20, my + 12 + bob - squash);

    ctx.fillStyle = '#ffdbac';
    ctx.fillRect(mx + 8, my + 20 - squash, 24, 22 + squash);

    ctx.fillStyle = 'black';
    ctx.fillRect(mario.dir > 0 ? mx + 21 : mx + 11, my + 26 + bob*0.4, 6, 7);

    ctx.fillStyle = '#000';
    ctx.fillRect(mx + 13, my + 36 + bob*0.5, 14, 6);

    ctx.fillStyle = mario.power ? '#ffd700' : '#c41e3a';
    ctx.fillRect(mx + 4, my + 38 + bob, 32, 22);

    ctx.fillStyle = '#ffff00';
    ctx.fillRect(mx + 11, my + 42 + bob, 8, 8);
    ctx.fillRect(mx + 21, my + 42 + bob, 8, 8);

    ctx.fillStyle = 'white';
    ctx.fillRect(mx + (mario.dir > 0 ? 2 : 29), my + 40 + bob, 10, 16);

    ctx.fillStyle = '#8b4513';
    const foot = mario.dir > 0 ? bob : -bob;
    ctx.fillRect(mx + 7 + foot, my + 56 + Math.abs(bob)*0.2, 13, 12);
    ctx.fillRect(mx + 20 - foot, my + 56 - Math.abs(bob)*0.2, 13, 12);

    ctx.restore();
}

function loop() {
    if (active) update();
    render();
    requestAnimationFrame(loop);
}
</script>
</body>
</html>
